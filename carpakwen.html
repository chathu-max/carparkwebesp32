<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Park System</title>
    <link rel="stylesheet" href="carparkweb.css">
    <link rel="stylesheet" href="carparkweb.scss">
    <!-- <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .parking-system {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            width: 100%;
            max-width: 1200px;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .main-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .lcd-display {
            background: #001122;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #333;
            font-family: 'Courier New', monospace;
            font-size: 1.2em;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .lcd-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 48%, rgba(0,255,0,0.1) 50%, transparent 52%);
            pointer-events: none;
        }

        .lcd-line {
            display: block;
            margin: 10px 0;
            height: 25px;
            line-height: 25px;
        }

        .status-indicators {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
        }

        .led-indicator {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }

        .led-green {
            background: #2ecc71;
            color: white;
            animation: pulse-green 2s infinite;
        }

        .led-red {
            background: #e74c3c;
            color: white;
            animation: pulse-red 1s infinite;
        }

        .led-off {
            background: #95a5a6;
            color: #666;
        }

        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 20px rgba(46,204,113,0.5); }
            50% { box-shadow: 0 0 30px rgba(46,204,113,0.8); }
        }

        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 20px rgba(231,76,60,0.5); }
            50% { box-shadow: 0 0 30px rgba(231,76,60,0.8); }
        }

        .gate-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .gate-status {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin: 20px 0;
        }

        .gate {
            flex: 1;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .gate-open {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        .gate-closed {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .gate::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }

        .gate-open::before {
            left: 100%;
        }

        .sensor-area {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .sensor {
            display: inline-block;
            width: 80px;
            height: 80px;
            background: #bdc3c7;
            border-radius: 50%;
            margin: 10px;
            position: relative;
            transition: all 0.3s ease;
        }

        .sensor-active {
            background: #f39c12;
            box-shadow: 0 0 20px rgba(243,156,18,0.6);
            animation: sensor-pulse 0.8s infinite;
        }

        @keyframes sensor-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .sensor::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background: #2c3e50;
            border-radius: 50%;
        }

        .control-panel {
            background: #34495e;
            padding: 20px;
            color: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .control-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .control-btn.emergency {
            background: #e74c3c;
        }

        .control-btn.emergency:hover {
            background: #c0392b;
        }

        .receipt-area {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .receipt {
            background: white;
            padding: 15px;
            border: 2px dashed #bdc3c7;
            border-radius: 5px;
            white-space: pre-line;
            max-height: 200px;
            overflow-y: auto;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #3498db;
            margin: 10px 0;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .active-vehicles {
            background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
            border: 2px solid #27ae60;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.1);
        }

        .active-vehicles h3 {
            color: #27ae60;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .vehicles-container {
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
        }

        .vehicles-container::-webkit-scrollbar {
            width: 8px;
        }

        .vehicles-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .vehicles-container::-webkit-scrollbar-thumb {
            background: #27ae60;
            border-radius: 10px;
        }

        .vehicles-container::-webkit-scrollbar-thumb:hover {
            background: #229954;
        }

        .vehicle-card {
            background: white;
            padding: 15px;
            margin: 8px 0;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
            animation: slideIn 0.5s ease-out;
        }

        .vehicle-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .vehicle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .vehicle-id {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .vehicle-status {
            background: #27ae60;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            text-transform: uppercase;
        }

        .vehicle-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .detail-icon {
            font-size: 1.2em;
        }

        .vehicle-cost {
            grid-column: span 2;
            text-align: center;
            margin-top: 8px;
            padding: 8px;
            background: #e8f5e8;
            border-radius: 8px;
            font-weight: bold;
            color: #27ae60;
            font-size: 1.1em;
        }

        .vehicle-actions {
            grid-column: span 2;
            text-align: center;
            margin-top: 10px;
        }

        .exit-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .exit-btn:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

        .no-vehicles {
            text-align: center;
            color: #7f8c8d;
            padding: 40px 20px;
            background: white;
            border-radius: 10px;
            border: 2px dashed #bdc3c7;
        }

        .no-vehicles-icon {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 300px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .modal select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .modal-btn.confirm {
            background: #e74c3c;
            color: white;
        }

        .modal-btn.cancel {
            background: #95a5a6;
            color: white;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .main-display {
                grid-template-columns: 1fr;
            }
            
            .control-panel {
                flex-direction: column;
                gap: 10px;
            }
            
            .gate-status {
                flex-direction: column;
            }

            .vehicle-details {
                grid-template-columns: 1fr;
            }

            .vehicle-cost {
                grid-column: span 1;
            }

            .vehicle-actions {
                grid-column: span 1;
            }
        }
    </style> -->
</head>
<body>
    <div class="parking-system" id="dashboard">
        <div class="header">
            <h1> Car Park System</h1>
            <p>Automated Parking Management System </p>
        </div>

        <div class="main-display">
            <div class="left-panel">
                <div class="lcd-display">
                    <div class="lcd-line" id="status-line">SPACE AVAILABLE</div>
                    <div class="lcd-line" id="count-line">Vehicles: 0/06</div>
                    <div class="lcd-line" id="rate-line">Rate: Rs.50/minute</div>
                </div>

                <div class="status-indicators">
                    <div class="led-indicator led-green" id="green-led">
                        Available
                    </div>
                    <div class="led-indicator led-off" id="red-led">
                        Full
                    </div>
                </div>

                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="current-count">0</div>
                        <div class="stat-label">Current Vehicles</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="available-spots">06</div>
                        <div class="stat-label">Available Spots</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-earnings">0</div>
                        <div class="stat-label">Total Earnings in a day (Rs.)</div>
                    </div>
                </div>

                <div class="active-vehicles">
                    <h3> Active Vehicles</h3>
                    <div class="vehicles-container" id="active-vehicles-list">
                        <div class="no-vehicles">
                            <div class="no-vehicles-icon">🅿️</div>
                            <p>No vehicles currently parked</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="gate-controls">
                    <h3>Gate Status</h3>
                    <div class="gate-status">
                        <div class="gate gate-closed" id="entry-gate">
                            <h4>Entry Gate</h4>
                            <p>CLOSED</p>
                        </div>
                        <div class="gate gate-closed" id="exit-gate">
                            <h4>Exit Gate</h4>
                            <p>CLOSED</p>
                        </div>
                    </div>
                </div>

                <div class="sensor-area">
                    <h3>Sensor Status</h3>
                    <div style="text-align: center;">
                        <div class="sensor" id="entry-sensor" title="Entry Sensor"></div>
                        <div class="sensor" id="exit-sensor" title="Exit Sensor"></div>
                    </div>
                    <p style="text-align: center; margin-top: 10px; color: #7f8c8d;">
                        Entry Sensor &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Exit Sensor
                    </p>
                </div>

                <div class="receipt-area">
                    <h3>Last Receipt</h3>
                    <div class="receipt" id="receipt-display">
=============================
     CAR PARK SYSTEM
=============================

PARKING RECEIPT

Rate: Rs.50 per minute

Welcome! Please keep this
receipt for exit billing.

=============================
                    </div>
                </div>
            </div>
        </div>

        <div class="control-panel">
            <button class="control-btn" onclick="simulateEntry()"> Simulate Entry</button>
            <!-- <button class="control-btn" onclick="simulateExit()"> Auto Exit (FIFO)</button>
            <button class="control-btn" onclick="showExitModal()"> Manual Exit</button> -->
            <button class="control-btn" onclick="resetSystem()"> Reset System</button>
            <button class="control-btn emergency" onclick="emergencyOpen()"> Emergency Open</button>
        </div>
    </div>



   <!-- <script src="carparkweb.js"></script> -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
    // Firebase config is declared and initialized below, only once.
</script>


  <script>
    

                let currentVehicleCount = 0;
                const MAX_PARKING_SPOTS = 6;
                const RATE_PER_MINUTE = 50; // Rs.50 per minute
                let entryGateOpen = false;
                let exitGateOpen = false;
                let totalEarnings = 0;
                let vehicleId = 1;
                let parkedVehicles = {}; // Store vehicle entry times
                let total = 6;

                // Firebase config (only declare once)
                const firebaseConfig = {
                    apiKey: "AIzaSyDTwybJzvUae23kME5yfPjDDEtYb-pPNNQ",
                    authDomain: "carparkwebb.firebaseapp.com",
                    databaseURL: "https://carparkwebb-default-rtdb.firebaseio.com",
                    projectId: "carparkwebb",
                    storageBucket: "carparkwebb.appspot.com",
                    messagingSenderId: "117598054372",
                    appId: "1:117598054372:web:06c477d9af9a0ea66289f1"
                };

                // Initialize Firebase only once
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                const db = firebase.database();

                // Listen for total_count and current_count
                db.ref("/total_count").on("value", snapshot => {
                    total = snapshot.val() || MAX_PARKING_SPOTS;
                    // No element with id 'total', so skip updating it
                    // document.getElementById("total").textContent = total;
                    // Update available spots
                    document.getElementById("available-spots").textContent = total - currentVehicleCount;
                });

                db.ref("/current_count").on("value", snapshot => {
                    currentVehicleCount = snapshot.val() || 0;
                    updateDisplay();
                });

        function openEntryGate() {
            if (!entryGateOpen) {
                entryGateOpen = true;
                console.log('Entry gate opened');
                // Update the display
                const statusLine = document.getElementById('status-line');
                statusLine.textContent = 'Entry gate opened';
                statusLine.style.color = 'green';
                // Update the LED
                const greenLed = document.getElementById('green-led');
                greenLed.className = 'led-indicator led-green';
            }
        }
        function updateDisplay() {
            const statusLine = document.getElementById('status-line');
            const countLine = document.getElementById('count-line');
            const greenLed = document.getElementById('green-led');
            const redLed = document.getElementById('red-led');
            const currentCountEl = document.getElementById('current-count');
            const availableSpotsEl = document.getElementById('available-spots');
            const totalEarningsEl = document.getElementById('total-earnings');

            if (currentVehicleCount < MAX_PARKING_SPOTS) {
                statusLine.textContent = 'SPACE AVAILABLE';
                greenLed.className = 'led-indicator led-green';
                redLed.className = 'led-indicator led-off';
            } else {
                statusLine.textContent = 'CAR PARK FULL';
                greenLed.className = 'led-indicator led-off';
                redLed.className = 'led-indicator led-red';
            }

            countLine.textContent = `Vehicles: ${currentVehicleCount}/${MAX_PARKING_SPOTS}`;
            currentCountEl.textContent = currentVehicleCount;
            availableSpotsEl.textContent = MAX_PARKING_SPOTS - currentVehicleCount;
            totalEarningsEl.textContent = totalEarnings.toFixed(2);

            updateActiveVehiclesList();
        }


        // Update gate display
function updateGateDisplay() {
    const entryGate = document.getElementById('entry-gate');
    const exitGate = document.getElementById('exit-gate');
    
    if (entryGateOpen) {
        entryGate.className = 'gate gate-open';
        entryGate.innerHTML = '<h4>Entry Gate</h4><p>OPEN</p>';
    } else {
        entryGate.className = 'gate gate-closed';
        entryGate.innerHTML = '<h4>Entry Gate</h4><p>CLOSED</p>';
    }
    
    if (exitGateOpen) {
        exitGate.className = 'gate gate-open';
        exitGate.innerHTML = '<h4>Exit Gate</h4><p>OPEN</p>';
    } else {
        exitGate.className = 'gate gate-closed';
        exitGate.innerHTML = '<h4>Exit Gate</h4><p>CLOSED</p>';
    }
}
        function updateActiveVehiclesList() {
            const listEl = document.getElementById('active-vehicles-list');
            
            if (Object.keys(parkedVehicles).length === 0) {
                listEl.innerHTML = `
                    <div class="no-vehicles">
                        <div class="no-vehicles-icon">🅿️</div>
                        <p>No vehicles currently parked</p>
                    </div>
                `;
                return;
            }

            const now = Date.now();
            let vehicleCards = '';
            
            Object.entries(parkedVehicles).forEach(([id, entryTime]) => {
                const parkedMinutes = Math.floor((now - entryTime) / (1000 * 60));
                const currentCost = parkedMinutes * RATE_PER_MINUTE;
                const entryDate = new Date(entryTime);
                const entryTimeStr = entryDate.toLocaleTimeString();
                
                vehicleCards += `
                    <div class="vehicle-card">
                        <div class="vehicle-header">
                            <div class="vehicle-id"> Vehicle #${id}</div>
                            <div class="vehicle-status">Parked</div>
                        </div>
                        <div class="vehicle-details">
                            <div class="detail-item">
                                <span class="detail-icon">time</span>
                                <span>Entry: ${entryTimeStr}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-icon">⏱</span>
                                <span>Duration: ${parkedMinutes} min</span>
                            </div>
                            <div class="vehicle-cost">
                                 Current Cost: Rs.${currentCost}
                            </div>
                            <div class="vehicle-actions">
                                <button class="exit-btn" onclick="exitSpecificVehicle('${id}')">
                                     Exit This Vehicle
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listEl.innerHTML = vehicleCards;
        }

        function simulateEntry() {
            const entrySensor = document.getElementById('entry-sensor');
            const entryGate = document.getElementById('entry-gate');
            const receiptDisplay = document.getElementById('receipt-display');
            
            entrySensor.classList.add('sensor-active');
            
            if (currentVehicleCount < MAX_PARKING_SPOTS) {
                currentVehicleCount++;
                const currentVehicleId = vehicleId++;
                parkedVehicles[currentVehicleId] = Date.now();
                
                entryGate.className = 'gate gate-open';
                entryGate.innerHTML = '<h4>Entry Gate</h4><p>OPEN</p>';
                
                // Generate entry receipt
                const now = new Date();
                const timeString = now.toLocaleTimeString();
                const dateString = now.toLocaleDateString();
                const receipt = `=============================
     CAR PARK SYSTEM
=============================

ENTRY RECEIPT

Vehicle ID: ${currentVehicleId}
Date: ${dateString}
Time: ${timeString}

Rate: Rs.${RATE_PER_MINUTE} per minute

Please keep this receipt
for exit billing.

=============================`;
                
                receiptDisplay.textContent = receipt;
                
                setTimeout(() => {
                    entryGate.className = 'gate gate-closed';
                    entryGate.innerHTML = '<h4>Entry Gate</h4><p>CLOSED</p>';
                }, 3000);
            } else {
                // Simulate denial
                const statusLine = document.getElementById('status-line');
                const countLine = document.getElementById('count-line');
                statusLine.textContent = 'ENTRY DENIED';
                countLine.textContent = 'CAR PARK FULL';
                
                setTimeout(() => {
                    updateDisplay();
                }, 2000);
            }
            
            setTimeout(() => {
                entrySensor.classList.remove('sensor-active');
            }, 1000);
            
            updateDisplay();
        }

        function simulateExit() {
            const exitSensor = document.getElementById('exit-sensor');
            const exitGate = document.getElementById('exit-gate');
            const receiptDisplay = document.getElementById('receipt-display');
            
            if (currentVehicleCount > 0) {
                exitSensor.classList.add('sensor-active');
                
                // Get the first vehicle to exit (FIFO)
                const vehicleIds = Object.keys(parkedVehicles);
                if (vehicleIds.length > 0) {
                    const exitingVehicleId = vehicleIds[0];
                    processVehicleExit(exitingVehicleId, exitSensor, exitGate, receiptDisplay);
                }
            }
            
            updateDisplay();
        }

        function exitSpecificVehicle(vehicleId) {
            const exitSensor = document.getElementById('exit-sensor');
            const exitGate = document.getElementById('exit-gate');
            const receiptDisplay = document.getElementById('receipt-display');
            
            exitSensor.classList.add('sensor-active');
            processVehicleExit(vehicleId, exitSensor, exitGate, receiptDisplay);
            updateDisplay();
        }

        function processVehicleExit(exitingVehicleId, exitSensor, exitGate, receiptDisplay) {
            const entryTime = parkedVehicles[exitingVehicleId];
            const exitTime = Date.now();
            const parkedDuration = exitTime - entryTime;
            const parkedMinutes = Math.ceil(parkedDuration / (1000 * 60)); // Round up to next minute
            const billAmount = parkedMinutes * RATE_PER_MINUTE;
            
            // Update earnings and remove vehicle
            totalEarnings += billAmount;
            delete parkedVehicles[exitingVehicleId];
            currentVehicleCount--;
            
            exitGate.className = 'gate gate-open';
            exitGate.innerHTML = '<h4>Exit Gate</h4><p>OPEN</p>';
            
            // Generate exit receipt
            const now = new Date();
            const entryDate = new Date(entryTime);
            const timeString = now.toLocaleTimeString();
            const dateString = now.toLocaleDateString();
            const receipt = `=============================
     CAR PARK SYSTEM
=============================

EXIT RECEIPT

Vehicle ID: ${exitingVehicleId}
Entry: ${entryDate.toLocaleTimeString()}
Exit: ${timeString}
Date: ${dateString}

Duration: ${parkedMinutes} minutes
Rate: Rs.${RATE_PER_MINUTE}/minute
Total: Rs.${billAmount}

Thank you for using our
car park facility!

Remaining spaces: ${MAX_PARKING_SPOTS - currentVehicleCount}

=============================`;
            
            receiptDisplay.textContent = receipt;
            
            setTimeout(() => {
                exitGate.className = 'gate gate-closed';
                exitGate.innerHTML = '<h4>Exit Gate</h4><p>CLOSED</p>';
                exitSensor.classList.remove('sensor-active');
            }, 3000);
        }

        function resetSystem() {
            currentVehicleCount = 0;
            totalEarnings = 0;
            vehicleId = 1;
            parkedVehicles = {};
            
            document.getElementById('entry-gate').className = 'gate gate-closed';
            document.getElementById('exit-gate').className = 'gate gate-closed';
            document.getElementById('entry-gate').innerHTML = '<h4>Entry Gate</h4><p>CLOSED</p>';
            document.getElementById('exit-gate').innerHTML = '<h4>Exit Gate</h4><p>CLOSED</p>';
            
            const receiptDisplay = document.getElementById('receipt-display');
            receiptDisplay.textContent = `=============================
     CAR PARK SYSTEM
=============================

PARKING RECEIPT

Rate: Rs.50 per minute

Welcome! Please keep this
receipt for exit billing.

=============================`;
            
            updateDisplay();
        }

        function emergencyOpen() {
            document.getElementById('entry-gate').className = 'gate gate-open';
            document.getElementById('exit-gate').className = 'gate gate-open';
            document.getElementById('entry-gate').innerHTML = '<h4>Entry Gate</h4><p>EMERGENCY OPEN</p>';
            document.getElementById('exit-gate').innerHTML = '<h4>Exit Gate</h4><p>EMERGENCY OPEN</p>';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('exitModal');
            if (event.target == modal) {
                closeExitModal();
            }
        }


        // Fetch system status periodically
async function fetchSystemStatus() {
    const status = await callESP32API('status');
    
    if (status) {
        currentVehicleCount = status.currentVehicles;
        totalEarnings = status.totalEarnings;
        entryGateOpen = status.entryGateOpen;
        exitGateOpen = status.exitGateOpen;
        
        updateDisplay();
        updateGateDisplay();
    }
}

// Update sensor indicators based on activity
function updateSensorIndicators() {
    // This would be called by ESP32 WebSocket or polling
    // For now, we'll simulate based on gate status
    const entrySensor = document.getElementById('entry-sensor');
    const exitSensor = document.getElementById('exit-sensor');
    
    if (entryGateOpen) {
        entrySensor.classList.add('sensor-active');
    } else {
        entrySensor.classList.remove('sensor-active');
    }
    
    if (exitGateOpen) {
        exitSensor.classList.add('sensor-active');
    } else {
        exitSensor.classList.remove('sensor-active');
    }
}

// Initialize system when page loads
document.addEventListener('DOMContentLoaded', function() {
    updateDisplay();
    
    // Fetch initial status from ESP32
    fetchSystemStatus();
    
    // Set up periodic status updates
    setInterval(fetchSystemStatus, 5000); // Every 5 seconds
    
    // Update active vehicles list every minute
    setInterval(updateActiveVehiclesList, 60000);
    
    // Update sensor indicators
    setInterval(updateSensorIndicators, 1000);
    
    console.log("ESP32 Car Park System initialized");
});

// Add connection status indicator
function updateConnectionStatus() {
    // This function can be used to show ESP32 connection status
    const header = document.querySelector('.header');
    
    fetch('/api/status')
        .then(response => response.ok)
        .then(connected => {
            if (connected) {
                header.style.borderBottom = '3px solid #27ae60';
                header.querySelector('p').textContent = 'ESP32 Connected - Automated Parking Management System';
            } else {
                header.style.borderBottom = '3px solid #e74c3c';
                header.querySelector('p').textContent = 'ESP32 Disconnected - Check Hardware Connection';
            }
        })
        .catch(() => {
            header.style.borderBottom = '3px solid #e74c3c';
            header.querySelector('p').textContent = 'ESP32 Disconnected - Check Hardware Connection';
        });
}

// WebSocket connection for real-time updates (optional enhancement)
function initWebSocket() {
    // This can be implemented for real-time sensor updates
    // const ws = new WebSocket(`ws://${window.location.host}/ws`);
    // ws.onmessage = function(event) {
    //     const data = JSON.parse(event.data);
    //     handleWebSocketMessage(data);
    // };
}

// Handle WebSocket messages for real-time updates
function handleWebSocketMessage(data) {
    switch(data.type) {
        case 'sensor_entry':
            document.getElementById('entry-sensor').classList.add('sensor-active');
            setTimeout(() => {
                document.getElementById('entry-sensor').classList.remove('sensor-active');
            }, 2000);
            break;
            
        case 'sensor_exit':
            document.getElementById('exit-sensor').classList.add('sensor-active');
            setTimeout(() => {
                document.getElementById('exit-sensor').classList.remove('sensor-active');
            }, 2000);
            break;
            
        case 'gate_status':
            entryGateOpen = data.entryGate;
            exitGateOpen = data.exitGate;
            updateGateDisplay();
            break;
            
        case 'vehicle_count':
            currentVehicleCount = data.count;
            totalEarnings = data.earnings;
            updateDisplay();
            break;
    }
}

// Test functions for development
function testEntry() {
    simulateEntry();
    console.log("Test entry triggered");
}

function testExit() {
    if (Object.keys(parkedVehicles).length > 0) {
        const firstVehicleId = Object.keys(parkedVehicles)[0];
        exitSpecificVehicle(firstVehicleId);
        console.log("Test exit triggered for vehicle:", firstVehicleId);
    } else {
        console.log("No vehicles to exit");
    }
}

// Test ultrasonic sensors
async function testUltrasonicSensors() {
    try {
        const result = await callESP32API('sensors');
        
        if (result) {
            const receiptDisplay = document.getElementById('receipt-display');
            receiptDisplay.textContent = `=============================
     ULTRASONIC SENSOR TEST
=============================

Entry Sensor:
Distance: ${result.entryDistance}cm
Vehicle Detected: ${result.entryDetected ? 'YES' : 'NO'}

Exit Sensor:  
Distance: ${result.exitDistance}cm
Vehicle Detected: ${result.exitDetected ? 'YES' : 'NO'}

Detection Threshold: ${result.detectionThreshold}cm

Sensor Status: ACTIVE
Hardware: HC-SR04
Range: 2-400cm

=============================`;
            
            console.log('Sensor Test Results:', result);
        }
    } catch (error) {
        console.error('Sensor test failed:', error);
    }
}

// Add keyboard shortcut for sensor testing
document.addEventListener('keydown', function(event) {
    if (event.ctrlKey) {
        switch(event.key) {
            case 'e':
                event.preventDefault();
                testEntry();
                break;
            case 'x':
                event.preventDefault();
                testExit();
                break;
            case 'r':
                event.preventDefault();
                resetSystem();
                break;
            case 's':
                event.preventDefault();
                testUltrasonicSensors();
                break;
        }
    }
});

// Check connection status periodically
setInterval(updateConnectionStatus, 10000); // Every 10 seconds


        // Update active vehicles list every minute to show current costs
        setInterval(updateActiveVehiclesList, 60000);

        // Initialize display
        updateDisplay();
  </script>
</body>
</html>